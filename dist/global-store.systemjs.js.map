{"version":3,"file":"global-store.systemjs.js","sources":["../src/errors.ts","../src/util.ts","../src/createReadonlyStore.ts","../src/createStore.ts"],"sourcesContent":["export class Prohibited extends Error {\n  constructor(public moduleName: string, public action: string) {\n    super(`Unable to '${action}' on a locked store used by module '${moduleName}'`)\n\n    Object.setPrototypeOf(this, new.target.prototype)\n  }\n}\n\nexport class AccessedBeforeLock extends Error {\n  constructor(public moduleName: string) {\n    super(`A readonly store from '${moduleName}' is being accessed before it is locked. Please call the approprate function in '${moduleName}' to lock the store.`)\n\n    Object.setPrototypeOf(this, new.target.prototype)\n  }\n}\n","import { StoreId, Stores, StoreValue, StoreInitializer } from './types';\n\nexport function getStoreValue(stores: Stores, id: StoreId): any {\n  const moduleStore = getModuleStore(stores, id.moduleName)\n  return moduleStore[id.key as any].value\n}\n\nexport function initStoreValue<T extends StoreValue>(stores: Stores, id: StoreId, initializer: StoreInitializer<T>) {\n  const moduleStore = getModuleStore(stores, id.moduleName)\n  const store = moduleStore[id.key as any]\n  const init = initializer(store && store.init || {})\n  moduleStore[id.key as any] = { init, value: createStoreValue(init) }\n}\n\nexport function resetStoreValue(stores: Stores, id: StoreId) {\n  const moduleStore = getModuleStore(stores, id.moduleName)\n  moduleStore[id.key as any].value = createStoreValue(moduleStore[id.key as any].init)\n}\n\nexport function getModuleStore(stores: Stores, moduleName: string) {\n  return stores[moduleName] = stores[moduleName] || {}\n}\n\nexport function createStoreValue(initialValue: any) {\n  return { ...initialValue }\n}\n","import { Store } from './createStore';\nimport { Prohibited, AccessedBeforeLock } from './errors';\nimport { StoreId, StoreInitializer, Stores, StoreValue } from './types';\nimport { getModuleStore, getStoreValue, initStoreValue, resetStoreValue } from './util';\n\n/**\n * Store mode:\n * 'readonly': The store in\n */\nexport type StoreMode = 'readonly' | 'writable'\n\nconst readonlyStores: Stores = {}\n\nexport type ReadonlyStore<T extends StoreValue> = Store<T> & {\n  /**\n   * Gets a writable value from the store.\n   * This can be used for configure the store value before it is locked.\n   * This is useful if your configuration is distributed in nature.\n   * When configuration is completed,\n   * you should `lock()` the store and use the `get()` method.\n   */\n  getWritable(): T\n  /**\n   * Open the store for testing.\n   * Calling this function will make the store not readonly.\n   * It will behaves just like the normal `Store`.\n   * Obviously, you should only call this during testing.\n   */\n  openForTesting(): void,\n  /**\n   * Freezes the store so that it cannot be modified.\n   */\n  lock(finalizer?: Partial<{ [K in keyof T]: (current: T[K]) => T[K] }>): ReadonlyStore<T>\n}\n\n/**\n * Creates a readonly store of type T.\n * @param id A unique identifier to the store.\n * @param initializer Initializing function for the store\n * @param mode The store mode. Defaults to 'initialize'.\n */\nexport function createReadonlyStore<\n  T extends StoreValue\n>(id: StoreId, initializer: StoreInitializer<T>): ReadonlyStore<T> {\n  initStoreValue(readonlyStores, id, initializer)\n  let isLocked = false\n  let testing = false\n  return {\n    openForTesting() {\n      if (isLocked) throw new Prohibited(id.moduleName, 'enable testing')\n      testing = true\n    },\n    // todo: getter/setter for properties\n    get() {\n      if (!testing && !isLocked) throw new AccessedBeforeLock(id.moduleName)\n      return getStoreValue(readonlyStores, id)\n    },\n    getWritable() {\n      if (!testing && isLocked) throw new Prohibited(id.moduleName, 'ReadonlyStore#getWritable')\n      return getStoreValue(readonlyStores, id)\n    },\n    lock(finalizer) {\n      if (!isLocked) {\n        if (finalizer) {\n          updateStoreValue(readonlyStores, id, finalizer)\n        }\n        freezeStoreValue(readonlyStores, id)\n        isLocked = true\n        testing = false\n      }\n      return this\n    },\n    reset() {\n      if (!testing && isLocked) throw new Prohibited(id.moduleName, 'ReadonlyStore#reset')\n      resetStoreValue(readonlyStores, id)\n    }\n  }\n}\n\n\nfunction updateStoreValue(stores: Stores, id: StoreId, finalizer: any /* Record<any, (value: any) => any> */) {\n  const moduleStore = getModuleStore(stores, id.moduleName)\n  const current = moduleStore[id.key as any].value\n\n  Object.keys(finalizer).forEach(k => current[k] = finalizer[k](current[k]))\n}\n\nfunction freezeStoreValue(stores: Stores, id: StoreId) {\n  const moduleStore = getModuleStore(stores, id.moduleName)\n  const store = moduleStore[id.key as any]\n\n  moduleStore[id.key as any] = {\n    init: store.init,\n    value: freezeValue(store.value)\n  }\n}\n\nfunction freezeValue(storeValue: StoreValue) {\n  Object.keys(storeValue).forEach(k => freezeArray(storeValue, k))\n  // istanbul ignore next\n  if (Object.getOwnPropertySymbols) {\n    Object.getOwnPropertySymbols(storeValue).forEach(k => freezeArray(storeValue, k))\n  }\n\n  return Object.freeze(storeValue)\n}\n\nfunction freezeArray(storeValue: StoreValue, k: any) {\n  const value = storeValue[k]\n  if (Array.isArray(value)) {\n    storeValue[k] = Object.freeze(value)\n  }\n}\n","import { StoreId, StoreInitializer, Stores, StoreValue } from './types';\nimport { getStoreValue, initStoreValue, resetStoreValue } from './util';\n\nexport type Store<T extends StoreValue> = {\n  /**\n   * Gets value from the store.\n   */\n  get(): T\n  /**\n   * Resets the store to its initial value.\n   * You should only use this during testing.\n   */\n  reset(): void\n}\n\nconst stores: Stores = {}\n\n/**\n * Creates a store of type T.\n * @param id A unique identifier to the store.\n * @param initializer Initializing function for the store\n */\nexport function createStore<\n  T extends StoreValue\n>(id: StoreId, initializer: StoreInitializer<T>): Store<T> {\n  initStoreValue(stores, id, initializer)\n\n  return {\n    get: () => getStoreValue(stores, id),\n    reset: () => resetStoreValue(stores, id)\n  }\n}\n"],"names":["tslib_1.__extends"],"mappings":"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"}